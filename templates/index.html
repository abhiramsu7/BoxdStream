<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoxdStream - Letterboxd Streaming Finder</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Vercel Web Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    <style>
        .footer { margin-top: auto; padding: 40px 20px; text-align: center; border-top: 1px solid rgba(255, 255, 255, 0.1); background: rgba(0, 0, 0, 0.2); }
        .footer-container { display: flex; flex-direction: column; gap: 12px; align-items: center; justify-content: center; }
        .main-tagline { font-size: 1.1rem; font-weight: 600; color: var(--text-primary, #fff); margin: 0; min-height: 24px; transition: opacity 0.5s ease; }
        .attribution { font-size: 0.8rem; color: var(--text-secondary, rgba(255, 255, 255, 0.5)); font-weight: 300; letter-spacing: 0.5px; }
        .attribution .brand { color: var(--text-primary, #fff); font-weight: 600; opacity: 0.8; }
        .heart { display: inline-block; color: #e50914; animation: heartbeat 1.5s infinite ease-in-out; }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    </style>
</head>
<body>

<div id="loader" class="loader hidden">
    <div class="spinner"></div>
    <div class="loading-text">Connecting to the streaming multiverse...</div>
</div>

<header class="nav">
    <a href="/" class="logo"><span class="logo-boxd">Boxd</span><span class="logo-stream">Stream</span></a>
    <div class="nav-right">
        <div class="nav-toolbar"><button class="theme-btn" onclick="toggleTheme()" title="Toggle Theme">üåô</button></div>
    </div>
</header>

<div class="hero-bg">
    <div class="hero">
        <h1>Turn your <span>Letterboxd</span><br>lists into <span>Weekend Plans</span>.</h1>
        <p style="color:var(--muted); max-width:500px; margin:0 auto; line-height:1.6;">Check where your favorite movies and shows are streaming across 50+ platforms instantly.</p>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-msg {{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="mode-toggle">
            <button class="mode-btn active" id="search-btn" onclick="switchMode('search')">Search Title</button>
            <button class="mode-btn" id="csv-btn" onclick="switchMode('csv')">Upload Watchlist</button>
        </div>

        <form class="hero-form" id="search-form" action="/" method="POST">
            <input type="hidden" name="mode" value="search">
            <div style="position:relative; flex:1; min-width:250px;">
                <input type="text" name="title" class="search-input" placeholder="Search for a movie or TV show..." required autocomplete="off" id="movie-search">
                <div id="autocomplete-list" class="autocomplete-dropdown"></div>
            </div>
            <input type="hidden" name="tmdb_id" id="tmdb_id">
            <input type="hidden" name="media_type" id="media_type">
            <select name="region_code" id="region-select-search">
                <option value="IN" selected>India (IN)</option>
                <option value="US">United States (US)</option>
                <option value="GB">United Kingdom (GB)</option>
                <option value="CA">Canada (CA)</option>
                <option value="AU">Australia (AU)</option>
                <option value="BR">Brazil (BR)</option>
                <option value="FR">France (FR)</option>
                <option value="DE">Germany (DE)</option>
            </select>
            <button type="submit">Search</button>
        </form>

        <form class="hero-form hidden" id="csv-form" action="/" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="mode" value="csv">
            <input type="file" name="file" accept=".csv" required>
            <select name="region_code" id="region-select-csv">
                <option value="IN" selected>India (IN)</option>
                <option value="US">United States (US)</option>
                <option value="GB">United Kingdom (GB)</option>
                <option value="CA">Canada (CA)</option>
                <option value="AU">Australia (AU)</option>
                <option value="BR">Brazil (BR)</option>
                <option value="FR">France (FR)</option>
                <option value="DE">Germany (DE)</option>
            </select>
            <button type="submit">Upload & Check</button>
        </form>

        <small class="availability-note">üí° <strong>Tip:</strong> Export your watchlist from Letterboxd (Settings > Import & Export) or search for individual titles to get started.</small>
    </div>
</div>

<footer class="footer">
    <div class="footer-container">
        <p id="home-tagline" class="main-tagline">Made with <span class="heart">‚ù§Ô∏è</span> for Cinema</p>
        <div class="attribution"><span class="brand">BoxdStream</span> ‚Ä¢ Powered by TMDB</div>
    </div>
</footer>

<script src="{{ url_for('static', filename='theme.js') }}"></script>
<script>
    // === 1. TAGLINE & LOADING TEXT LOGIC (Keep existing) ===
    document.addEventListener("DOMContentLoaded", function() {
        const taglines = [ "Made with <span class='heart'>‚ù§Ô∏è</span> for Cinema.", "Because life is too short for bad buffers. üçø", "Turning 'One day' into 'Today'. üé¨", "Every movie has a home. We just find it. üè†", "From our watchlist to yours. üíå", "Cinema is a language we all speak. üåç", "Less searching, more watching. üçø", "Curated for the cinephile in you. ‚≠ê", "Clearing watchlists, one stream at a time. ‚úÖ", "Built by fans, for the fans. <span class='heart'>‚ù§Ô∏è</span>", "The magic of movies, just a click away. ‚ú®", "Your watchlist called. It wants to be watched. üìû"];
        const taglineElement = document.getElementById('home-tagline');
        function changeTagline() {
            taglineElement.style.opacity = 0; 
            setTimeout(() => {
                const index = Math.floor(Math.random() * taglines.length);
                taglineElement.innerHTML = taglines[index];
                taglineElement.style.opacity = 1; 
            }, 500);
        }
        setInterval(changeTagline, 5000);
    });

    const weekdayMessages = { morning: ["Brewing your morning coffee...", "Finding a movie to go with breakfast...", "Loading... (Don't forget your coffee)"], evening: ["Skipping work to watch movies? Nice.", "Finding the perfect lunch break watch...", "Scanning 50+ platforms..."], night: ["Sleep is for the weak. Movies are forever.", "Popcorn is popping... buttering the data...", "Checking if it's too scary for 2 AM..."] };
    const weekendMessages = { morning: ["Weekend rule #1: Movies in bed are mandatory.", "It's the weekend. You're allowed to start watching at 10 AM."], evening: ["Saturday night plans: Me, my couch, and this movie.", "Ordering pizza... Scanning for a blockbuster..."], night: ["No work tomorrow! One more movie won't hurt.", "Late night binge session initiating..."] };
    const regionTimezones = { 'IN': 'Asia/Kolkata', 'US': 'America/New_York', 'GB': 'Europe/London', 'CA': 'America/Toronto', 'AU': 'Australia/Sydney', 'BR': 'America/Sao_Paulo', 'FR': 'Europe/Paris', 'DE': 'Europe/Berlin' };

    function startLoadingText() {
        const textElement = document.querySelector('.loading-text');
        if (!textElement) return;
        const activeForm = document.querySelector('form:not(.hidden)');
        const regionSelect = activeForm ? activeForm.querySelector('select[name="region_code"]') : null;
        const selectedRegion = regionSelect ? regionSelect.value : 'IN';
        const timeZone = regionTimezones[selectedRegion] || 'UTC';
        const date = new Date();
        const hourFormatter = new Intl.DateTimeFormat('en-US', { hour: 'numeric', hour12: false, timeZone: timeZone });
        const dayFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'short', timeZone: timeZone });
        const hour = parseInt(hourFormatter.format(date));
        const day = dayFormatter.format(date);
        const isWeekend = (day === 'Sat' || day === 'Sun');
        const messageSource = isWeekend ? weekendMessages : weekdayMessages;
        let selectedMessages = (hour >= 5 && hour < 12) ? messageSource.morning : (hour >= 12 && hour < 20) ? messageSource.evening : messageSource.night;
        let i = 0;
        textElement.textContent = selectedMessages[0];
        if (window.loadingInterval) clearInterval(window.loadingInterval);
        window.loadingInterval = setInterval(() => {
            i = (i + 1) % selectedMessages.length;
            textElement.style.opacity = 0; 
            setTimeout(() => { textElement.textContent = selectedMessages[i]; textElement.style.opacity = 1; }, 300);
        }, 2000); 
    }

    // === 2. SMOOTH SUBMIT FUNCTION (The Delay Fix) ===
    function smoothSubmit() {
        const loader = document.getElementById('loader');
        const autocompleteList = document.getElementById('autocomplete-list');
        const searchForm = document.getElementById('search-form');

        // 1. Hide dropdown immediately
        if(autocompleteList) {
            autocompleteList.innerHTML = '';
            autocompleteList.classList.remove('active');
        }

        // 2. Show Loader & Start Text
        if(loader) loader.classList.remove('hidden');
        startLoadingText();

        // 3. WAIT 1.5 SECONDS -> Then Submit
        setTimeout(() => {
            searchForm.submit();
        }, 1500); 
    }

    // Intercept default form submit button
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Stop instant submit
            smoothSubmit();     // Use smooth submit
        });
    });

    // === 3. AUTOCOMPLETE & ENTER KEY LOGIC ===
    const searchInput = document.getElementById('movie-search');
    const autocompleteList = document.getElementById('autocomplete-list');
    const regionSelect = document.getElementById('region-select-search'); 
    let debounceTimer;
    let currentFocus = -1; 

    if (searchInput) {
        
        // A. GLOBAL ENTER KEY LISTENER
        document.addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
                const activeElement = document.activeElement;
                const isDropdownOpen = autocompleteList.innerHTML.trim() !== "";

                // Case 1: Dropdown open + Item selected -> Click it
                if (isDropdownOpen && currentFocus > -1) {
                    e.preventDefault();
                    const items = autocompleteList.getElementsByClassName("autocomplete-item");
                    if (items[currentFocus]) items[currentFocus].click();
                } 
                // Case 2: Just hit Enter -> Smooth Submit
                else if (searchInput.value.trim().length > 0) {
                    if (!activeElement.tagName.match(/TEXTAREA|SELECT/) && activeElement !== document.querySelector('input[type="file"]')) {
                        e.preventDefault(); 
                        smoothSubmit(); 
                    }
                }
            }
        });

        // B. ARROW NAVIGATION
        searchInput.addEventListener("keydown", function(e) {
            let items = autocompleteList.getElementsByClassName("autocomplete-item");
            if (e.key === "ArrowDown") { currentFocus++; addActive(items); } 
            else if (e.key === "ArrowUp") { currentFocus--; addActive(items); }
        });

        function addActive(items) {
            if (!items) return false;
            removeActive(items);
            if (currentFocus >= items.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (items.length - 1);
            items[currentFocus].classList.add("selected");
            items[currentFocus].scrollIntoView({ block: 'nearest' });
        }

        function removeActive(items) {
            for (let i = 0; i < items.length; i++) items[i].classList.remove("selected");
        }

        // C. LIVE TYPING
        searchInput.addEventListener('input', function() {
            document.getElementById('tmdb_id').value = ''; 
            document.getElementById('media_type').value = '';
            
            clearTimeout(debounceTimer);
            const query = this.value;
            
            // Pass the current Region to backend for better suggestions
            const currentRegion = regionSelect ? regionSelect.value : 'IN';

            if (query.length < 2) { 
                autocompleteList.innerHTML = ''; 
                return; 
            }

            debounceTimer = setTimeout(() => {
                fetch(`/api/autocomplete?q=${encodeURIComponent(query)}&region=${currentRegion}`)
                    .then(response => response.json())
                    .then(data => {
                        autocompleteList.innerHTML = '';
                        currentFocus = -1;

                        data.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'autocomplete-item';
                            const typeBadge = item.media_type === 'movie' ? '<span class="type-badge badge-movie">MOVIE</span>' : '<span class="type-badge badge-tv">TV</span>';
                            
                            div.innerHTML = `
                                <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                                    <span><strong>${item.title}</strong> <span style="color:var(--muted); font-size:0.85rem">(${item.year})</span></span>
                                    ${typeBadge}
                                </div>
                            `;
                            
                            div.addEventListener('click', function() {
                                searchInput.value = item.title;
                                document.getElementById('tmdb_id').value = item.tmdb_id;
                                document.getElementById('media_type').value = item.media_type;
                                
                                // === CALL SMOOTH SUBMIT ===
                                smoothSubmit();
                            });
                            
                            autocompleteList.appendChild(div);
                        });
                    });
            }, 200);
        });
        
        document.addEventListener('click', function(e) {
            if (e.target !== searchInput && e.target !== autocompleteList) { autocompleteList.innerHTML = ''; }
        });
    }
</script>
</body>
</html>