<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BoxdStream - Letterboxd Streaming Finder</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div id="loader" class="loader hidden">
  <div class="spinner"></div>
  <div class="loading-text">Finding a movie before your dinner gets cold...</div>
</div>

<header class="nav">
  <a href="/" class="logo">
    <span class="logo-boxd">Boxd</span><span class="logo-stream">Stream</span>
  </a>
  <div class="nav-right">
    <div class="nav-toolbar">
      <button class="theme-btn" onclick="toggleTheme()" title="Toggle Theme">ðŸŒ™</button>
    </div>
  </div>
</header>

<div class="hero-bg">
  <div class="hero">
    <h1>Turn your <span>Letterboxd</span><br>lists into <span>Weekend Plans</span>.</h1>
    <p style="color:var(--muted); max-width:500px; margin:0 auto; line-height:1.6;">
      Check where your favorite movies and shows are streaming across 50+ platforms instantly.
    </p>

    <div class="mode-toggle">
      <button class="mode-btn active" id="search-btn" onclick="switchMode('search')">Search Title</button>
      <button class="mode-btn" id="csv-btn" onclick="switchMode('csv')">Upload Watchlist</button>
    </div>

    <form class="hero-form" id="search-form" action="/" method="POST">
      <input type="hidden" name="mode" value="search">
      
      <div style="position:relative; flex:1; min-width:250px;">
        <input type="text" name="title" class="search-input" placeholder="Search for a movie or TV show..." required autocomplete="off" id="movie-search">
        <div id="autocomplete-list" class="autocomplete-dropdown"></div>
      </div>

      <input type="hidden" name="tmdb_id" id="tmdb_id">
      <input type="hidden" name="media_type" id="media_type">

      <select name="region_code">
        <option value="IN" selected>India (IN)</option>
        <option value="US">United States (US)</option>
        <option value="GB">United Kingdom (GB)</option>
        <option value="CA">Canada (CA)</option>
        <option value="AU">Australia (AU)</option>
        <option value="BR">Brazil (BR)</option>
        <option value="FR">France (FR)</option>
        <option value="DE">Germany (DE)</option>
      </select>

      <button type="submit">Search</button>
    </form>

    <form class="hero-form hidden" id="csv-form" action="/" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="mode" value="csv">
      
      <input type="file" name="file" accept=".csv" required>
      
      <select name="region_code">
        <option value="IN" selected>India (IN)</option>
        <option value="US">United States (US)</option>
        <option value="GB">United Kingdom (GB)</option>
      </select>

      <button type="submit">Upload & Check</button>
    </form>

    <small class="availability-note">
      ðŸ’¡ <strong>Tip:</strong> Export your watchlist from Letterboxd (Settings > Import & Export) or search for individual titles to get started.
    </small>
  </div>
</div>

<footer class="footer">
  <p>BoxdStream â€¢ Powered by TMDB</p>
</footer>

<script src="{{ url_for('static', filename='theme.js') }}"></script>
<script>
  // === CINEPHILE LOADING TEXT ===
  const loadingMessages = [
    "Finding a movie before your dinner gets cold...",
    "Scanning the multiverse for streaming rights...",
    "Still faster than 20 minutes of doom-scrolling...",
    "Popcorn is popping... buttering the data...",
    "Asking the projectionist to wake up...",
    "Consulting the Oracle for availability...",
    "Rerouting the flux capacitor...",
    "Assembling the Avengers of streaming apps...",
    "Loading... (No spoilers included)"
  ];

  function startLoadingText() {
    const textElement = document.querySelector('.loading-text');
    if (!textElement) return;

    let i = 0;
    // Set first message immediately
    textElement.textContent = loadingMessages[0];
    
    setInterval(() => {
        i = (i + 1) % loadingMessages.length;
        textElement.style.opacity = 0; // Fade out
        
        setTimeout(() => {
            textElement.textContent = loadingMessages[i];
            textElement.style.opacity = 1; // Fade in
        }, 300);
        
    }, 2000); // Change every 2 seconds
  }

  // Trigger on Form Submit
  document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function() {
      document.getElementById('loader').classList.remove('hidden');
      startLoadingText();
    });
  });

  // === AUTOCOMPLETE LOGIC ===
  const searchInput = document.getElementById('movie-search');
  const autocompleteList = document.getElementById('autocomplete-list');
  let debounceTimer;

  searchInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    const query = this.value;
    
    if (query.length < 3) {
      autocompleteList.innerHTML = '';
      return;
    }

    debounceTimer = setTimeout(() => {
      fetch(`https://api.themoviedb.org/3/search/multi?api_key=5b421e05cad15891667ec28db3d9b9ac&query=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          autocompleteList.innerHTML = '';
          const results = data.results.filter(item => item.media_type === 'movie' || item.media_type === 'tv').slice(0, 5);
          
          results.forEach(item => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            const title = item.title || item.name;
            const year = (item.release_date || item.first_air_date || '').split('-')[0];
            const typeBadge = item.media_type === 'movie' ? '<span class="type-badge badge-movie">MOVIE</span>' : '<span class="type-badge badge-tv">TV</span>';
            
            div.innerHTML = `<strong>${title}</strong> <span style="color:var(--muted); font-size:0.85rem">(${year})</span> ${typeBadge}`;
            
            div.addEventListener('click', function() {
              searchInput.value = title;
              document.getElementById('tmdb_id').value = item.id;
              document.getElementById('media_type').value = item.media_type;
              autocompleteList.innerHTML = '';
            });
            
            autocompleteList.appendChild(div);
          });
        });
    }, 300);
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (e.target !== searchInput) {
      autocompleteList.innerHTML = '';
    }
  });
</script>

</body>
</html>