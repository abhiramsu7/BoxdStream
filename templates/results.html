<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoxdStream Results</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .heart { display: inline-block; color: #e50914; animation: heartbeat 1.5s infinite ease-in-out; }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .summary-theatrical strong { color: #f59e0b !important; }
        .summary-theatrical:hover { border-color: #f59e0b !important; }
        .card { cursor: pointer; } 
    </style>
</head>
<body>

<header class="nav">
    <a href="/" class="logo"><span class="logo-boxd">Boxd</span><span class="logo-stream">Stream</span></a>
    <div class="nav-right">
        <div class="nav-toolbar">
            <a href="/" class="icon-btn" title="New Search / Back">‚Üê</a>
            <div class="separator"></div>
            <button class="theme-btn" onclick="toggleTheme()" title="Toggle Theme">üåô</button>
        </div>
    </div>
</header>

<div class="closure-banner">
    <p class="closure-text">Watchlists deserve closure <span class="heart">‚ù§Ô∏è</span></p>
</div>

<section class="summary">
    <div onclick="filterMovies('free', null)" style="cursor:pointer"><strong>{{ summary.available_free }}</strong><span>Free to Watch</span></div>
    <div onclick="filterMovies('Rent', null)" style="cursor:pointer"><strong>{{ summary.rent_or_buy }}</strong><span>Rent / Buy</span></div>
    <div onclick="filterMovies('theatrical', null)" class="summary-theatrical" style="cursor:pointer"><strong>{{ summary.in_theaters }}</strong><span>In Theaters</span></div>
    <div onclick="filterMovies('unavailable', null)" style="cursor:pointer"><strong>{{ summary.not_streaming }}</strong><span>Not Streaming</span></div>
    <div onclick="filterMovies('unreleased', null)" style="cursor:pointer"><strong>{{ summary.unreleased }}</strong><span>Coming Soon</span></div>
</section>

<div class="filter-bar-container">
    <div class="filter-bar">
        <button class="filter-btn active" onclick="filterMovies('all', this)">All</button>
        {% if 'netflix' in active_providers %} <button class="filter-btn" onclick="filterMovies('Netflix', this)">Netflix</button> {% endif %}
        {% if 'prime' in active_providers %} <button class="filter-btn" onclick="filterMovies('Prime', this)">Prime Video</button> {% endif %}
        {% if 'apple' in active_providers %} <button class="filter-btn" onclick="filterMovies('Apple', this)">Apple TV</button> {% endif %}
        {% if region == 'IN' %}
            {% if 'hotstar' in active_providers %} <button class="filter-btn" onclick="filterMovies('JioHotstar', this)">JioHotstar</button> {% endif %}
            {% if 'zee5' in active_providers %} <button class="filter-btn" onclick="filterMovies('Zee5', this)">ZEE5</button> {% endif %}
            {% if 'sony' in active_providers %} <button class="filter-btn" onclick="filterMovies('Sony', this)">SonyLIV</button> {% endif %}
            {% if 'aha' in active_providers %} <button class="filter-btn" onclick="filterMovies('Aha', this)">Aha</button> {% endif %}
        {% endif %}
        {% if region != 'IN' %}
            {% if 'disney' in active_providers %} <button class="filter-btn" onclick="filterMovies('Disney', this)">Disney+</button> {% endif %}
            {% if 'hulu' in active_providers %} <button class="filter-btn" onclick="filterMovies('Hulu', this)">Hulu</button> {% endif %}
        {% endif %}
        <button class="filter-btn" onclick="filterMovies('Rent', this)">Rent/Buy</button>
    </div>
</div>

<section class="grid">
{% for movie in results %}
    <div class="card {{ movie.ui_class }}" 
         data-status="{{ 'free' if movie.ui_class == 'streaming' else 'other' }}"
         data-specific-status="{{ movie.status }}"
         onclick="openModal(this)"> 
        
        <div class="hidden-data" style="display:none;">
            <span class="data-title">{{ movie.title }}</span>
            <span class="data-year">{{ movie.year }}</span>
            <span class="data-overview">{{ movie.overview }}</span>
            <span class="data-director">{{ movie.director }}</span>
            <span class="data-cast">{{ movie.cast }}</span>
            <span class="data-trailer">{{ movie.trailer }}</span>
            <span class="data-type">{{ movie.type }}</span>
            <span class="data-seasons">{{ movie.seasons }}</span>
            <span class="data-lastep">{{ movie.last_ep }}</span>
            
            <div class="data-deep-links">
                {% if movie.deep_links %}
                    <div style="margin-top:10px;">
                        <p style="font-size:0.9rem; color:var(--muted); margin-bottom:8px;">Availability unsure?</p>
                        {% for link in movie.deep_links %}
                            <a href="{{ link.url }}" target="_blank" class="quick-link" style="width:100%; text-align:center; justify-content:center;">{{ link.name }}</a>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="data-providers">
                {% if movie.providers %}
                    {% for p in movie.providers %}
                        <a href="{{ p.link }}" target="_blank" class="provider-icon" title="Watch on {{ p.name }}">
                            {% if p.logo %}<img src="{{ p.logo }}">{% else %}<span>{{ p.name[:3] }}</span>{% endif %}
                        </a>
                    {% endfor %}
                {% else %}
                    <span style="color:#9aa0b4">No streaming links available.</span>
                {% endif %}
            </div>
        </div>

        {% if movie.poster %}
            <img src="{{ movie.poster }}" alt="{{ movie.title }}" class="poster" loading="lazy">
        {% else %}
            <div class="poster placeholder"><span>No Poster</span></div>
        {% endif %}

        <h3>{{ movie.title }}</h3>
        <div class="year">{{ movie.year }}</div>

        <div class="card-status">
            {% if movie.providers %}
                <div class="provider-grid">
                {% for p in movie.providers %}
                    <div class="provider-icon" data-name="{{ p.name }}" data-label="{{ p.label }}">
                        {% if p.logo %}<img src="{{ p.logo }}">{% endif %}
                        {% if p.label != 'Subscription' %}<span class="mini-tag">{{ p.label }}</span>{% endif %}
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <span class="static-status" 
                      style="color: {% if movie.status == 'In Theaters' %}#f59e0b{% elif movie.status == 'Coming Soon' %}#22c55e{% elif movie.status == 'Digital Release Soon' %}#3b82f6{% else %}#9aa0b4{% endif %}; font-weight:700; font-size:0.9rem;">
                    {{ movie.status }}
                </span>
            {% endif %}
        </div>
    </div>
{% endfor %}
</section>

<div id="movie-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">√ó</button>
        
        <div id="modal-video-container" class="modal-video" style="display:none;">
            <iframe id="modal-iframe" src="" allowfullscreen></iframe>
        </div>
        
        <div id="modal-yt-link" style="display:none; padding: 0 24px;">
            <a href="#" target="_blank" id="yt-anchor" class="yt-btn">
                <svg class="yt-icon" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
                Watch on YouTube
            </a>
        </div>

        <div class="modal-body">
            <h2 id="modal-title" class="modal-title">Movie Title</h2>
            <div class="modal-meta">
                <span id="modal-year">2024</span> ‚Ä¢ <span id="modal-director" style="color:var(--accent)">Director</span>
            </div>
            
            <div id="modal-tv-details" style="display:none; margin-bottom: 12px; background:rgba(124,124,255,0.1); padding:10px; border-radius:8px;">
                <span style="display:block; font-weight:700; color:var(--accent);">üì∫ Series Info</span>
                <span id="modal-seasons"></span> ‚Ä¢ <span id="modal-lastep"></span>
            </div>

            <p id="modal-desc" class="modal-desc">Description...</p>
            
            <div class="modal-cast">
                <h4>Starring</h4>
                <p id="modal-cast-list">Actor 1, Actor 2</p>
            </div>
            
            <div class="modal-providers">
                <h4>Where to Watch</h4>
                <div id="modal-providers-list" class="provider-grid" style="gap:10px;"></div>
                
                <div id="modal-deep-links" style="margin-top:16px;"></div>
            </div>
        </div>
    </div>
</div>

<div id="empty-state" class="empty-state hidden">
    <div class="empty-icon" id="empty-emoji">üëª</div>
    <h3 id="empty-title">It's a ghost town here.</h3>
    <p id="empty-desc">None of your watchlist movies match this filter.</p>
    <button onclick="filterMovies('all', document.querySelector('.filter-btn'))" class="reset-btn">View All Movies</button>
</div>

<footer class="footer">
    <div class="attribution"><span>BoxdStream</span> ‚Ä¢ Powered by TMDB</div>
</footer>

<script src="{{ url_for('static', filename='theme.js') }}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const cards = document.querySelectorAll('.card');
        if (cards.length === 1) { openModal(cards[0]); }
    });

    const modal = document.getElementById('movie-modal');
    const iframe = document.getElementById('modal-iframe');
    const vidContainer = document.getElementById('modal-video-container');
    const ytLinkContainer = document.getElementById('modal-yt-link');
    const ytAnchor = document.getElementById('yt-anchor');
    const tvDetails = document.getElementById('modal-tv-details');
    const deepLinksContainer = document.getElementById('modal-deep-links');

    function openModal(card) {
        const data = card.querySelector('.hidden-data');
        document.getElementById('modal-title').textContent = data.querySelector('.data-title').textContent;
        document.getElementById('modal-year').textContent = data.querySelector('.data-year').textContent;
        document.getElementById('modal-desc').textContent = data.querySelector('.data-overview').textContent;
        document.getElementById('modal-director').textContent = data.querySelector('.data-director').textContent;
        document.getElementById('modal-cast-list').textContent = data.querySelector('.data-cast').textContent;
        document.getElementById('modal-providers-list').innerHTML = data.querySelector('.data-providers').innerHTML;

        // INJECT JUSTWATCH LINK
        const deepLinksData = data.querySelector('.data-deep-links');
        if (deepLinksData && deepLinksData.innerHTML.trim() !== "") {
            deepLinksContainer.innerHTML = deepLinksData.innerHTML;
            deepLinksContainer.style.display = 'block';
        } else {
            deepLinksContainer.style.display = 'none';
        }

        const type = data.querySelector('.data-type').textContent;
        if (type === 'tv') {
            tvDetails.style.display = 'block';
            document.getElementById('modal-seasons').textContent = data.querySelector('.data-seasons').textContent + " Seasons";
            document.getElementById('modal-lastep').textContent = "Latest: " + data.querySelector('.data-lastep').textContent;
        } else {
            tvDetails.style.display = 'none';
        }

        const trailerKey = data.querySelector('.data-trailer').textContent;
        if (trailerKey && trailerKey !== 'None') {
            iframe.src = `https://www.youtube.com/embed/${trailerKey}?autoplay=1`;
            vidContainer.style.display = 'block';
            ytAnchor.href = `https://www.youtube.com/watch?v=${trailerKey}`;
            ytLinkContainer.style.display = 'block';
        } else {
            iframe.src = '';
            vidContainer.style.display = 'none';
            ytLinkContainer.style.display = 'none';
        }
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        modal.classList.remove('active');
        iframe.src = '';
        document.body.style.overflow = '';
    }

    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('active')) closeModal(); });

    // Filter Logic remains the same (Corrected Selector)
    const emptyMessages = {
        'netflix': { emoji: "üì∫", title: "Tudum... Silence.", desc: "Are you still watching? Because we couldn't find any matches here." },
        'prime': { emoji: "üì¶", title: "Delivery Delayed.", desc: "Even Prime One-Day delivery couldn't find these movies." },
        'aha': { emoji: "üß°", title: "Aha! ... Em Kanipinchadam Ledu.", desc: "100% Telugu, but 0% found in this list. Try another filter!" },
        'hotstar': { emoji: "üèè", title: "Out for a Duck!", desc: "Disney magic couldn't conjure up these results." },
        'zee5': { emoji: "ü¶ì", title: "Zee-ro Results Found.", desc: "Looks like the drama is happening elsewhere." },
        'sonyliv': { emoji: "üõãÔ∏è", title: "LIV a Little...", desc: "...somewhere else. No matches found here." },
        'jio': { emoji: "üì∂", title: "Network Issue?", desc: "Just kidding, your net is fine. The movies just aren't here." },
        'apple': { emoji: "üçé", title: "Too Expensive?", desc: "Maybe these movies were too premium for this list." },
        'free': { emoji: "üí∏", title: "No Free Lunch.", desc: "All these movies require rent or aren't streaming yet." },
        'rent': { emoji: "üí≥", title: "Wallet Safe.", desc: "Nothing to rent or buy here." },
        'unreleased': { emoji: "üìÖ", title: "All Released!", desc: "Every movie in your list has already hit the screens." },
        'unavailable': { emoji: "üéâ", title: "Everything is Streaming!", desc: "Great news! All your movies are available somewhere." },
        'theatrical': { emoji: "üçø", title: "Grab Popcorn!", desc: "These movies are exclusively in theaters right now." },
        'default': { emoji: "üëª", title: "It's a ghost town here.", desc: "None of your watchlist movies match this filter." }
    };

    function filterMovies(filter, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        if (btn) btn.classList.add('active');
        else if (filter === 'all') document.querySelector('.filter-btn').classList.add('active');

        const cards = document.querySelectorAll('.card');
        let visibleCount = 0;
        
        cards.forEach(card => {
            const badges = card.querySelectorAll('.card-status .provider-icon');
            const cardStatus = card.getAttribute('data-specific-status');
            let showCard = false;

            if (filter === 'all') {
                showCard = true;
                badges.forEach(b => b.style.display = 'block');
            } else if (filter === 'free') {
                let hasSub = false;
                badges.forEach(b => { if (b.getAttribute('data-label') === 'Subscription') hasSub = true; });
                if (hasSub) showCard = true;
                badges.forEach(b => { b.style.display = (b.getAttribute('data-label') === 'Subscription') ? 'block' : 'none'; });
            } else if (filter === 'unavailable') {
                if (cardStatus === 'Not Streaming' || cardStatus === 'Not Found') showCard = true;
            } else if (filter === 'unreleased') {
                if (cardStatus === 'Coming Soon') showCard = true;
            } else if (filter === 'theatrical') {
                if (cardStatus === 'In Theaters') showCard = true;
            } else {
                let hasProviderMatch = false;
                badges.forEach(badge => {
                    const name = badge.getAttribute('data-name');
                    const label = badge.getAttribute('data-label');
                    if (!name || !label) return;

                    const nameLower = name.toLowerCase();
                    const labelLower = label.toLowerCase();
                    const filterLower = filter.toLowerCase();
                    let isMatch = false;
                    
                    if (filter === 'JioHotstar') { if (nameLower.includes('jio') || nameLower.includes('hotstar') || nameLower.includes('disney')) isMatch = true; }
                    else if (filter === 'Rent') { if (labelLower.includes('rent') || labelLower.includes('buy')) isMatch = true; }
                    else { if (nameLower.includes(filterLower)) isMatch = true; }

                    if (isMatch) { badge.style.display = 'block'; hasProviderMatch = true; } 
                    else { badge.style.display = 'none'; }
                });
                if (hasProviderMatch) showCard = true;
            }

            if (showCard) { card.classList.remove('hidden'); visibleCount++; } 
            else { card.classList.add('hidden'); }
        });

        const emptyState = document.getElementById('empty-state');
        if (visibleCount === 0) {
            emptyState.classList.remove('hidden');
            let key = 'default';
            const p = filter.toLowerCase();
            for (const k in emptyMessages) { if (p.includes(k)) key = k; }
            const msg = emptyMessages[key] || emptyMessages['default'];
            document.getElementById('empty-emoji').textContent = msg.emoji;
            document.getElementById('empty-title').textContent = msg.title;
            document.getElementById('empty-desc').textContent = msg.desc;
        } else {
            emptyState.classList.add('hidden');
        }
    }
</script>
</body>
</html>